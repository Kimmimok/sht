'use client';

import { useState } from 'react';
import PageWrapper from '@/components/PageWrapper';
import SectionBox from '@/components/SectionBox';
import supabase from '@/lib/supabase';

export default function DatabaseManagementPage() {
    const [loading, setLoading] = useState(false);
    const [setupResult, setSetupResult] = useState<string>('');
    const [foreignKeys, setForeignKeys] = useState<any[]>([]);

    // CASCADE DELETE Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÏÑ§Ï†ï
    const setupCascadeDelete = async () => {
        try {
            setLoading(true);
            setSetupResult('CASCADE DELETE Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ÏùÑ ÏÑ§Ï†ïÌïòÎäî Ï§ë...');

            // SQL Ïã§ÌñâÏùÑ ÏúÑÌïú Ïó¨Îü¨ Îã®Í≥Ñ Ï≤òÎ¶¨
            const setupQueries = [
                // 1. quote_item.quote_id -> quote.id CASCADE DELETE
                `
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM information_schema.table_constraints 
                        WHERE constraint_name LIKE '%quote_item%quote%' 
                        AND table_name = 'quote_item'
                        AND constraint_type = 'FOREIGN KEY'
                    ) THEN
                        EXECUTE (
                            SELECT 'ALTER TABLE quote_item DROP CONSTRAINT ' || constraint_name
                            FROM information_schema.table_constraints 
                            WHERE constraint_name LIKE '%quote_item%quote%' 
                            AND table_name = 'quote_item'
                            AND constraint_type = 'FOREIGN KEY'
                            LIMIT 1
                        );
                    END IF;
                    
                    ALTER TABLE quote_item 
                    ADD CONSTRAINT fk_quote_item_quote_id 
                    FOREIGN KEY (quote_id) 
                    REFERENCES quote(id) 
                    ON DELETE CASCADE;
                    
                EXCEPTION 
                    WHEN OTHERS THEN
                        RAISE NOTICE 'quote_item Ïô∏ÎûòÌÇ§ ÏÑ§Ï†ï Ï§ë Ïò§Î•ò: %', SQLERRM;
                END$$;
                `,

                // 2. reservation.re_quote_id -> quote.id CASCADE DELETE
                `
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM information_schema.table_constraints 
                        WHERE constraint_name LIKE '%reservation%quote%' 
                        AND table_name = 'reservation'
                        AND constraint_type = 'FOREIGN KEY'
                    ) THEN
                        EXECUTE (
                            SELECT 'ALTER TABLE reservation DROP CONSTRAINT ' || constraint_name
                            FROM information_schema.table_constraints 
                            WHERE constraint_name LIKE '%reservation%quote%' 
                            AND table_name = 'reservation'
                            AND constraint_type = 'FOREIGN KEY'
                            LIMIT 1
                        );
                    END IF;
                    
                    ALTER TABLE reservation 
                    ADD CONSTRAINT fk_reservation_quote_id 
                    FOREIGN KEY (re_quote_id) 
                    REFERENCES quote(id) 
                    ON DELETE CASCADE;
                    
                EXCEPTION 
                    WHEN OTHERS THEN
                        RAISE NOTICE 'reservation Ïô∏ÎûòÌÇ§ ÏÑ§Ï†ï Ï§ë Ïò§Î•ò: %', SQLERRM;
                END$$;
                `,

                // 3. reservation_cruise.reservation_id -> reservation.re_id CASCADE DELETE
                `
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM information_schema.table_constraints 
                        WHERE constraint_name LIKE '%reservation_cruise%reservation%' 
                        AND table_name = 'reservation_cruise'
                        AND constraint_type = 'FOREIGN KEY'
                    ) THEN
                        EXECUTE (
                            SELECT 'ALTER TABLE reservation_cruise DROP CONSTRAINT ' || constraint_name
                            FROM information_schema.table_constraints 
                            WHERE constraint_name LIKE '%reservation_cruise%reservation%' 
                            AND table_name = 'reservation_cruise'
                            AND constraint_type = 'FOREIGN KEY'
                            LIMIT 1
                        );
                    END IF;
                    
                    ALTER TABLE reservation_cruise 
                    ADD CONSTRAINT fk_reservation_cruise_reservation_id 
                    FOREIGN KEY (reservation_id) 
                    REFERENCES reservation(re_id) 
                    ON DELETE CASCADE;
                    
                EXCEPTION 
                    WHEN OTHERS THEN
                        RAISE NOTICE 'reservation_cruise Ïô∏ÎûòÌÇ§ ÏÑ§Ï†ï Ï§ë Ïò§Î•ò: %', SQLERRM;
                END$$;
                `
            ];

            // Í∞Å ÏøºÎ¶¨Î•º ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§Ìñâ
            for (let i = 0; i < setupQueries.length; i++) {
                const { error } = await supabase.rpc('exec_sql', {
                    sql: setupQueries[i]
                });

                if (error) {
                    console.error(`ÏøºÎ¶¨ ${i + 1} Ïã§Ìñâ Ïò§Î•ò:`, error);
                    setSetupResult(prev => prev + `\n‚ùå ÏøºÎ¶¨ ${i + 1} Ïã§Ìñâ Ïã§Ìå®: ${error.message}`);
                } else {
                    setSetupResult(prev => prev + `\n‚úÖ ÏøºÎ¶¨ ${i + 1} Ïã§Ìñâ ÏôÑÎ£å`);
                }
            }

            setSetupResult(prev => prev + '\n\nüéâ CASCADE DELETE ÏÑ§Ï†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');

            // ÏÑ§Ï†ï ÏôÑÎ£å ÌõÑ Ïô∏ÎûòÌÇ§ ÏÉÅÌÉú ÌôïÏù∏
            await checkForeignKeys();

        } catch (error) {
            console.error('CASCADE DELETE ÏÑ§Ï†ï Ïò§Î•ò:', error);
            setSetupResult(prev => prev + `\n‚ùå ÏÑ§Ï†ï Ï§ë Ïò§Î•ò Î∞úÏÉù: ${error}`);
        } finally {
            setLoading(false);
        }
    };

    // ÌòÑÏû¨ Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÌôïÏù∏
    const checkForeignKeys = async () => {
        try {
            const { data, error } = await supabase.rpc('exec_sql', {
                sql: `
                    SELECT 
                        tc.table_name,
                        kcu.column_name,
                        ccu.table_name AS foreign_table_name,
                        ccu.column_name AS foreign_column_name,
                        tc.constraint_name,
                        rc.delete_rule
                    FROM 
                        information_schema.table_constraints AS tc 
                        JOIN information_schema.key_column_usage AS kcu
                            ON tc.constraint_name = kcu.constraint_name
                        JOIN information_schema.constraint_column_usage AS ccu
                            ON ccu.constraint_name = tc.constraint_name
                        JOIN information_schema.referential_constraints AS rc
                            ON tc.constraint_name = rc.constraint_name
                    WHERE 
                        tc.constraint_type = 'FOREIGN KEY' 
                        AND (ccu.table_name = 'quote' OR tc.table_name IN ('quote_item', 'reservation', 'reservation_cruise'))
                    ORDER BY tc.table_name, kcu.column_name;
                `
            });

            if (error) {
                console.error('Ïô∏ÎûòÌÇ§ Ï°∞Ìöå Ïò§Î•ò:', error);
                return;
            }

            setForeignKeys(data || []);
        } catch (error) {
            console.error('Ïô∏ÎûòÌÇ§ ÌôïÏù∏ Ï§ë Ïò§Î•ò:', error);
        }
    };

    // Í≤¨Ï†Å ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ (Ï£ºÏùòÌï¥ÏÑú ÏÇ¨Ïö©)
    const [testQuoteId, setTestQuoteId] = useState<string>('');
    const [deleteTestResult, setDeleteTestResult] = useState<string>('');

    const testQuoteDelete = async () => {
        if (!testQuoteId) {
            alert('ÌÖåÏä§Ìä∏Ìï† Í≤¨Ï†Å IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            return;
        }

        const confirmed = confirm(`Í≤¨Ï†Å ID ${testQuoteId}ÏôÄ Ïó∞Í≤∞Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!`);
        if (!confirmed) return;

        try {
            setLoading(true);
            setDeleteTestResult('Í≤¨Ï†Å ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ Ï§ë...');

            // ÏÇ≠Ï†ú Ï†Ñ Ïó∞Í≤∞Îêú Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
            const { data: quoteItems } = await supabase
                .from('quote_item')
                .select('id')
                .eq('quote_id', testQuoteId);

            const { data: reservations } = await supabase
                .from('reservation')
                .select('re_id')
                .eq('re_quote_id', testQuoteId);

            setDeleteTestResult(prev => prev + `\nÏÇ≠Ï†ú Ï†Ñ Ïó∞Í≤∞ Îç∞Ïù¥ÌÑ∞: quote_item ${quoteItems?.length || 0}Í∞ú, reservation ${reservations?.length || 0}Í∞ú`);

            // Í≤¨Ï†Å ÏÇ≠Ï†ú (CASCADE DELETEÎ°ú Ïó∞Í≤∞Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏûêÎèô ÏÇ≠Ï†ú)
            const { error: deleteError } = await supabase
                .from('quote')
                .delete()
                .eq('id', testQuoteId);

            if (deleteError) {
                setDeleteTestResult(prev => prev + `\n‚ùå Í≤¨Ï†Å ÏÇ≠Ï†ú Ïã§Ìå®: ${deleteError.message}`);
                return;
            }

            setDeleteTestResult(prev => prev + `\n‚úÖ Í≤¨Ï†Å ID ${testQuoteId} Î∞è Ïó∞Í≤∞Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!`);

        } catch (error) {
            console.error('Í≤¨Ï†Å ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
            setDeleteTestResult(prev => prev + `\n‚ùå ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ Ï§ë Ïò§Î•ò: ${error}`);
        } finally {
            setLoading(false);
        }
    };

    return (
        <PageWrapper>
            <div className="space-y-6">
                <div>
                    <h1 className="text-lg font-bold text-gray-800">üîß Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í¥ÄÎ¶¨</h1>
                    <p className="text-sm text-gray-600 mt-1">CASCADE DELETE Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÏÑ§Ï†ï Î∞è Í¥ÄÎ¶¨</p>
                </div>

                {/* CASCADE DELETE ÏÑ§Ï†ï */}
                <SectionBox title="CASCADE DELETE ÏÑ§Ï†ï">
                    <div className="space-y-4">
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 className="text-sm font-medium text-yellow-800 mb-2">‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠</h4>
                            <ul className="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ Ïù¥ ÏÑ§Ï†ïÏùÄ Í≤¨Ï†Å ÏÇ≠Ï†ú Ïãú Ïó∞Í≤∞Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏûêÎèôÏúºÎ°ú ÏÇ≠Ï†úÌï©ÎãàÎã§</li>
                                <li>‚Ä¢ quote ‚Üí quote_item, reservation ‚Üí reservation_cruise Í¥ÄÍ≥ÑÏóê CASCADE DELETE Ï†ÅÏö©</li>
                                <li>‚Ä¢ ÏÑ§Ï†ï Ï†Ñ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖÏùÑ Í∂åÏû•Ìï©ÎãàÎã§</li>
                            </ul>
                        </div>

                        <button
                            onClick={setupCascadeDelete}
                            disabled={loading}
                            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'ÏÑ§Ï†ï Ï§ë...' : 'CASCADE DELETE Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÏÑ§Ï†ï'}
                        </button>

                        {setupResult && (
                            <div className="bg-gray-50 p-4 rounded border">
                                <h4 className="text-sm font-medium text-gray-700 mb-2">ÏÑ§Ï†ï Í≤∞Í≥º:</h4>
                                <pre className="text-xs text-gray-600 whitespace-pre-wrap">{setupResult}</pre>
                            </div>
                        )}
                    </div>
                </SectionBox>

                {/* Ïô∏ÎûòÌÇ§ ÏÉÅÌÉú ÌôïÏù∏ */}
                <SectionBox title="Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ ÏÉÅÌÉú">
                    <div className="space-y-4">
                        <button
                            onClick={checkForeignKeys}
                            className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
                        >
                            Ïô∏ÎûòÌÇ§ ÏÉÅÌÉú ÌôïÏù∏
                        </button>

                        {foreignKeys.length > 0 && (
                            <div className="bg-white border rounded overflow-x-auto">
                                <table className="min-w-full text-sm">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ÌÖåÏù¥Î∏î</th>
                                            <th className="px-3 py-2 text-left">Ïª¨Îüº</th>
                                            <th className="px-3 py-2 text-left">Ï∞∏Ï°∞ ÌÖåÏù¥Î∏î</th>
                                            <th className="px-3 py-2 text-left">Ï∞∏Ï°∞ Ïª¨Îüº</th>
                                            <th className="px-3 py-2 text-left">ÏÇ≠Ï†ú Í∑úÏπô</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {foreignKeys.map((fk, index) => (
                                            <tr key={index} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                                <td className="px-3 py-2">{fk.table_name}</td>
                                                <td className="px-3 py-2">{fk.column_name}</td>
                                                <td className="px-3 py-2">{fk.foreign_table_name}</td>
                                                <td className="px-3 py-2">{fk.foreign_column_name}</td>
                                                <td className="px-3 py-2">
                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${fk.delete_rule === 'CASCADE'
                                                            ? 'bg-green-100 text-green-800'
                                                            : 'bg-red-100 text-red-800'
                                                        }`}>
                                                        {fk.delete_rule}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </SectionBox>

                {/* Í≤¨Ï†Å ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ */}
                <SectionBox title="Í≤¨Ï†Å ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏">
                    <div className="space-y-4">
                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h4 className="text-sm font-medium text-red-800 mb-2">üö® ÏúÑÌóò: Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</h4>
                            <p className="text-sm text-red-700">
                                Ïù¥ Í∏∞Îä•ÏùÄ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌï©ÎãàÎã§. Îß§Ïö∞ Ïã†Ï§ëÌïòÍ≤å ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.
                            </p>
                        </div>

                        <div className="flex space-x-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Í≤¨Ï†Å ID
                                </label>
                                <input
                                    type="number"
                                    value={testQuoteId}
                                    onChange={(e) => setTestQuoteId(e.target.value)}
                                    placeholder="ÏÇ≠Ï†úÌï† Í≤¨Ï†Å ID"
                                    className="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                />
                            </div>
                            <button
                                onClick={testQuoteDelete}
                                disabled={loading || !testQuoteId}
                                className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors disabled:opacity-50"
                            >
                                {loading ? 'ÏÇ≠Ï†ú Ï§ë...' : 'Í≤¨Ï†Å ÏÇ≠Ï†ú (CASCADE)'}
                            </button>
                        </div>

                        {deleteTestResult && (
                            <div className="bg-gray-50 p-4 rounded border">
                                <h4 className="text-sm font-medium text-gray-700 mb-2">ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏ Í≤∞Í≥º:</h4>
                                <pre className="text-xs text-gray-600 whitespace-pre-wrap">{deleteTestResult}</pre>
                            </div>
                        )}
                    </div>
                </SectionBox>
            </div>
        </PageWrapper>
    );
}
